---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
  title: string;
  descriptionNl: string;
  descriptionEn: string;
  rating: string;
  date: string;
  time: string;
  language?: string;
  subtitles?: string;
  headphones?: string;
  previewUrl?: string;
  imageUrl?: string;
  isNext?: boolean;
}

const { title, descriptionNl, descriptionEn, rating, date, time, language, subtitles, headphones, previewUrl, imageUrl, isNext } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get description based on current language
const description = lang === 'nl' ? descriptionNl : descriptionEn;

// Extract YouTube video ID for thumbnail
function getYouTubeThumbnail(url: string | undefined): string {
  if (!url) return '/images/movie-placeholder.svg';
  const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
  if (match) {
    return `https://img.youtube.com/vi/${match[1]}/maxresdefault.jpg`;
  }
  return '/images/movie-placeholder.svg';
}

const thumbnail = imageUrl || getYouTubeThumbnail(previewUrl);

// Format date for display
function formatDate(dateStr: string): string {
  try {
    const date = new Date(dateStr);
    return date.toLocaleDateString(lang === 'nl' ? 'nl-NL' : 'en-US', {
      weekday: 'long',
      day: 'numeric',
      month: 'long'
    });
  } catch {
    return dateStr;
  }
}
---

<article class:list={['movie-card', { 'is-next': isNext }]}>
  {isNext && (
    <div class="next-badge">
      {t('schedule.nextScreening')}
    </div>
  )}

  <div class="movie-image">
    <img src={thumbnail} alt={title} loading="lazy" />
    {previewUrl && (
      <a href={previewUrl} target="_blank" rel="noopener" class="play-button" aria-label={t('common.watchTrailer')}>
        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </a>
    )}
  </div>

  <div class="movie-content">
    <div class="movie-meta">
      <span class="movie-rating">{rating}</span>
      <span class="movie-date">{formatDate(date)}</span>
      <span class="movie-time">{time}</span>
    </div>

    <h3 class="movie-title">{title}</h3>
    <p class="movie-description">{description}</p>

    {(language || subtitles || headphones) && (
      <div class="movie-languages">
        {language && !['TBA', 'n/a', 'N/A', ''].includes(language) && (
          <span class="lang-tag" title={lang === 'nl' ? 'Gesproken taal' : 'Spoken language'}>
            üó£Ô∏è {language}
          </span>
        )}
        {subtitles && !['TBA', 'n/a', 'N/A', ''].includes(subtitles) && (
          <span class="lang-tag" title={lang === 'nl' ? 'Ondertiteling' : 'Subtitles'}>
            üí¨ {subtitles}
          </span>
        )}
        {headphones && !['TBA', 'n/a', 'N/A', ''].includes(headphones) && (
          <span class="lang-tag" title={lang === 'nl' ? 'Koptelefoon' : 'Headphones'}>
            üéß {headphones}
          </span>
        )}
      </div>
    )}
  </div>
</article>

<style>
  .movie-card {
    position: relative;
    background: var(--color-card);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-normal);
  }

  .movie-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  }

  .movie-card.is-next {
    border: 2px solid var(--color-accent);
  }

  .next-badge {
    position: absolute;
    top: var(--space-md);
    left: var(--space-md);
    z-index: 10;
    background: var(--color-accent);
    color: white;
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .movie-image {
    position: relative;
    aspect-ratio: 16 / 9;
    overflow: hidden;
  }

  .movie-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-normal);
  }

  .movie-card:hover .movie-image img {
    transform: scale(1.05);
  }

  .play-button {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.4);
    color: white;
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .movie-card:hover .play-button {
    opacity: 1;
  }

  .play-button svg {
    background: var(--color-accent);
    border-radius: 50%;
    padding: 12px;
    width: 64px;
    height: 64px;
    transition: transform var(--transition-fast);
  }

  .play-button:hover svg {
    transform: scale(1.1);
  }

  .movie-content {
    padding: var(--space-lg);
  }

  .movie-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    margin-bottom: var(--space-sm);
    font-size: 0.875rem;
  }

  .movie-rating {
    background: var(--color-gold);
    color: var(--color-primary);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-weight: 600;
  }

  .movie-date,
  .movie-time {
    color: var(--color-text-muted);
  }

  .movie-date::before {
    content: 'üìÖ ';
  }

  .movie-time::before {
    content: 'üïê ';
  }

  .movie-title {
    margin-bottom: var(--space-sm);
    font-size: 1.25rem;
  }

  .movie-description {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .movie-languages {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-top: var(--space-md);
  }

  .lang-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
</style>

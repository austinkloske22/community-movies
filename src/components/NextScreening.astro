---
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/utils';
import type { Movie } from '../lib/sheets';
import { getWeatherForDate, type WeatherData } from '../lib/weather';

interface Props {
  movie: Movie | null;
}

const { movie } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

let weather: WeatherData | null = null;

// Only fetch weather if movie is within forecast range (typically 16 days)
if (movie) {
  const movieDate = new Date(movie.date);
  const today = new Date();
  const daysUntil = Math.ceil((movieDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));

  if (daysUntil >= 0 && daysUntil <= 14) {
    weather = await getWeatherForDate(movie.date);
  }
}

// Format date for display
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString(lang === 'nl' ? 'nl-NL' : 'en-US', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

// Extract YouTube video ID
function getYouTubeId(url: string): string | null {
  const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([^&?]+)/);
  return match ? match[1] : null;
}

const youtubeId = movie?.previewUrl ? getYouTubeId(movie.previewUrl) : null;

// Get description based on current language
const description = movie ? (lang === 'nl' ? movie.descriptionNl : movie.descriptionEn) : '';
---

{movie ? (
  <section class="next-screening section">
    <div class="container">
      <div class="screening-header">
        <span class="screening-badge">{t('schedule.nextScreening')}</span>
        <h2 class="screening-title">{movie.title}</h2>
      </div>

      <div class="screening-content">
        <div class="screening-video">
          {youtubeId ? (
            <div class="video-wrapper">
              <iframe
                src={`https://www.youtube.com/embed/${youtubeId}`}
                title={`${movie.title} trailer`}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe>
            </div>
          ) : (
            <div class="video-placeholder">
              <span class="placeholder-icon">üé¨</span>
              <span>{lang === 'nl' ? 'Trailer komt binnenkort' : 'Trailer coming soon'}</span>
            </div>
          )}
        </div>

        <div class="screening-details">
          <div class="detail-card">
            <span class="detail-icon">üìÖ</span>
            <div class="detail-content">
              <span class="detail-label">{t('schedule.date')}</span>
              <span class="detail-value">{formatDate(movie.date)}</span>
            </div>
          </div>

          <div class="detail-card">
            <span class="detail-icon">üïê</span>
            <div class="detail-content">
              <span class="detail-label">{t('schedule.time')}</span>
              <span class="detail-value">{movie.time}</span>
            </div>
          </div>

          <div class="detail-card">
            <span class="detail-icon">üìç</span>
            <div class="detail-content">
              <span class="detail-label">{t('location.title')}</span>
              <span class="detail-value">Nelson Mandelapark, Haarlem</span>
            </div>
          </div>

          {weather && (
            <div class="detail-card weather-card">
              <span class="detail-icon">{weather.weatherIcon}</span>
              <div class="detail-content">
                <span class="detail-label">{t('weather.title')}</span>
                <span class="detail-value">
                  {weather.temperatureMin}¬∞ - {weather.temperatureMax}¬∞C
                  {weather.precipitationProbability > 30 && (
                    <span class="rain-chance">
                      üíß {weather.precipitationProbability}%
                    </span>
                  )}
                </span>
              </div>
            </div>
          )}

          <div class="rating-badge">
            <span class="rating-label">{lang === 'nl' ? 'Classificatie' : 'Rating'}</span>
            <span class="rating-value">{movie.rating}</span>
          </div>

          {(movie.language || movie.subtitles || movie.headphones) && (
            <div class="language-info">
              {movie.language && !['TBA', 'n/a', 'N/A', ''].includes(movie.language) && (
                <div class="lang-item">
                  <span class="lang-icon">üó£Ô∏è</span>
                  <span class="lang-label">{lang === 'nl' ? 'Taal' : 'Language'}:</span>
                  <span class="lang-value">{movie.language}</span>
                </div>
              )}
              {movie.subtitles && !['TBA', 'n/a', 'N/A', ''].includes(movie.subtitles) && (
                <div class="lang-item">
                  <span class="lang-icon">üí¨</span>
                  <span class="lang-label">{lang === 'nl' ? 'Ondertiteling' : 'Subtitles'}:</span>
                  <span class="lang-value">{movie.subtitles}</span>
                </div>
              )}
              {movie.headphones && !['TBA', 'n/a', 'N/A', ''].includes(movie.headphones) && (
                <div class="lang-item">
                  <span class="lang-icon">üéß</span>
                  <span class="lang-label">{lang === 'nl' ? 'Koptelefoon' : 'Headphones'}:</span>
                  <span class="lang-value">{movie.headphones}</span>
                </div>
              )}
            </div>
          )}

          <p class="screening-description">{description}</p>

          <a href={getLocalizedPath('/programma', lang)} class="btn btn-secondary">
            {lang === 'nl' ? 'Bekijk volledig programma' : 'View full schedule'}
          </a>
        </div>
      </div>
    </div>
  </section>
) : (
  <section class="next-screening section">
    <div class="container text-center">
      <p class="text-muted">{t('schedule.noUpcoming')}</p>
    </div>
  </section>
)}

<style>
  .next-screening {
    background: linear-gradient(180deg, var(--color-bg) 0%, var(--color-primary) 100%);
  }

  .screening-header {
    text-align: center;
    margin-bottom: var(--space-xl);
  }

  .screening-badge {
    display: inline-block;
    background: var(--color-accent);
    color: white;
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-lg);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-md);
  }

  .screening-title {
    font-size: clamp(2rem, 5vw, 3rem);
  }

  .screening-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-xl);
    align-items: start;
  }

  .video-wrapper {
    position: relative;
    padding-bottom: 56.25%;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  }

  .video-wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .video-placeholder {
    aspect-ratio: 16 / 9;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
    background: var(--color-card);
    border-radius: var(--radius-lg);
    color: var(--color-text-muted);
  }

  .placeholder-icon {
    font-size: 4rem;
  }

  .screening-details {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .detail-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    padding: var(--space-md);
  }

  .detail-icon {
    font-size: 1.5rem;
  }

  .detail-content {
    display: flex;
    flex-direction: column;
  }

  .detail-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }

  .detail-value {
    font-weight: 600;
  }

  .rain-chance {
    margin-left: var(--space-sm);
    color: var(--color-accent);
  }

  .rating-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    background: var(--color-gold);
    color: var(--color-primary);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-md);
    width: fit-content;
  }

  .rating-label {
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  .rating-value {
    font-weight: 700;
  }

  .language-info {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .lang-item {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
  }

  .lang-icon {
    font-size: 1rem;
  }

  .lang-label {
    color: var(--color-text-muted);
  }

  .lang-value {
    font-weight: 500;
  }

  .screening-description {
    color: var(--color-text-muted);
    line-height: 1.7;
  }

  @media (max-width: 900px) {
    .screening-content {
      grid-template-columns: 1fr;
    }
  }
</style>
